From 4df28d9e8b10268c63ede5515e269e0163d1d0d8 Mon Sep 17 00:00:00 2001
From: advaithm <advaith.madhukar@gmail.com>
Date: Sat, 17 Jul 2021 11:58:26 +0530
Subject: [PATCH 1/4] escape paths with regex over quotes in flatpaks

---
 app/src/lib/helpers/linux.ts | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/app/src/lib/helpers/linux.ts b/app/src/lib/helpers/linux.ts
index 73fe58887fe..2c6213f0885 100644
--- a/app/src/lib/helpers/linux.ts
+++ b/app/src/lib/helpers/linux.ts
@@ -82,9 +82,10 @@ export function spawnEditor(
   options: SpawnOptions
 ): ChildProcess {
   if (isFlatpakBuild()) {
+    let EscapedworkingDirectory = workingDirectory.replace(/(\s)/, "\\ ")
     return spawn(
       'flatpak-spawn',
-      ['--host', path, `"${workingDirectory}"`],
+      ['--host', path, EscapedworkingDirectory],
       options
     )
   } else {

From db8a7c7709658eb8fdae8772477c1d3668e5db31 Mon Sep 17 00:00:00 2001
From: advaithm <advaith.madhukar@gmail.com>
Date: Sun, 18 Jul 2021 19:16:00 +0530
Subject: [PATCH 2/4] Revert "escape paths with regex over quotes in flatpaks"

This reverts commit 4df28d9e8b10268c63ede5515e269e0163d1d0d8.
---
 app/src/lib/helpers/linux.ts | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/app/src/lib/helpers/linux.ts b/app/src/lib/helpers/linux.ts
index 2c6213f0885..73fe58887fe 100644
--- a/app/src/lib/helpers/linux.ts
+++ b/app/src/lib/helpers/linux.ts
@@ -82,10 +82,9 @@ export function spawnEditor(
   options: SpawnOptions
 ): ChildProcess {
   if (isFlatpakBuild()) {
-    let EscapedworkingDirectory = workingDirectory.replace(/(\s)/, "\\ ")
     return spawn(
       'flatpak-spawn',
-      ['--host', path, EscapedworkingDirectory],
+      ['--host', path, `"${workingDirectory}"`],
       options
     )
   } else {

From cde0844ece630b85cf9103e3dcd5aa6f3772f06a Mon Sep 17 00:00:00 2001
From: advaithm <advaith.madhukar@gmail.com>
Date: Sun, 18 Jul 2021 19:17:11 +0530
Subject: [PATCH 3/4] escape paths with regex over quotes in flatpaksv2

---
 app/src/lib/helpers/linux.ts | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/app/src/lib/helpers/linux.ts b/app/src/lib/helpers/linux.ts
index 73fe58887fe..2761f33db5e 100644
--- a/app/src/lib/helpers/linux.ts
+++ b/app/src/lib/helpers/linux.ts
@@ -82,9 +82,10 @@ export function spawnEditor(
   options: SpawnOptions
 ): ChildProcess {
   if (isFlatpakBuild()) {
+    let EscapedworkingDirectory = workingDirectory.replace(/(\s)/, "\ ")
     return spawn(
       'flatpak-spawn',
-      ['--host', path, `"${workingDirectory}"`],
+      ['--host', path, EscapedworkingDirectory],
       options
     )
   } else {

From b12fb5a709be9a1625108391850fbc42da9efdd0 Mon Sep 17 00:00:00 2001
From: advaithm <advaith.madhukar@gmail.com>
Date: Mon, 19 Jul 2021 06:42:07 +0530
Subject: [PATCH 4/4] split to sperate function and add unit test

---
 app/src/lib/helpers/linux.ts        |  6 ++++--
 app/test/unit/helpers/linux-test.ts | 16 +++++++++++++++-
 2 files changed, 19 insertions(+), 3 deletions(-)

diff --git a/app/src/lib/helpers/linux.ts b/app/src/lib/helpers/linux.ts
index 2761f33db5e..e6e021808b0 100644
--- a/app/src/lib/helpers/linux.ts
+++ b/app/src/lib/helpers/linux.ts
@@ -28,7 +28,9 @@ export function convertToFlatpakPath(path: string) {
 
   return join('/var/run/host', path)
 }
-
+export function formatWorkingDirectoryForFlatpak(path: string): string {
+  return path.replace(/(\s)/, "\ ")
+}
 /**
  * Checks the file path on disk exists before attempting to launch a specific shell
  *
@@ -82,7 +84,7 @@ export function spawnEditor(
   options: SpawnOptions
 ): ChildProcess {
   if (isFlatpakBuild()) {
-    let EscapedworkingDirectory = workingDirectory.replace(/(\s)/, "\ ")
+    let EscapedworkingDirectory = formatWorkingDirectoryForFlatpak(workingDirectory)
     return spawn(
       'flatpak-spawn',
       ['--host', path, EscapedworkingDirectory],
diff --git a/app/test/unit/helpers/linux-test.ts b/app/test/unit/helpers/linux-test.ts
index df18564e441..0f6895c8835 100644
--- a/app/test/unit/helpers/linux-test.ts
+++ b/app/test/unit/helpers/linux-test.ts
@@ -1,4 +1,4 @@
-import { convertToFlatpakPath } from '../../../src/lib/helpers/linux'
+import { convertToFlatpakPath, formatWorkingDirectoryForFlatpak } from '../../../src/lib/helpers/linux'
 
 describe('convertToFlatpakPath()', () => {
   if (__LINUX__) {
@@ -28,3 +28,17 @@ describe('convertToFlatpakPath()', () => {
     })
   }
 })
+
+describe('formatWorkingDirectoryForFlatpak()', () => {
+  if (__LINUX__) {
+    it('escapes string', () => {
+      const path = "/home/test/path with space"
+      const expectedPath = "/home/test/path\ with\ space"
+      expect(formatWorkingDirectoryForFlatpak(path)).toEqual(expectedPath)
+    })
+    it('returns same path', () => {
+      const path = "/home/test/path_wthout_spaces"
+      expect(formatWorkingDirectoryForFlatpak(path)).toEqual(path)
+    })
+  }
+})
